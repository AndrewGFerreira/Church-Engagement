---
title: "Churn analysis for churches using Rock RMS (Records Management System)"
author: "Andrew Ferreira"
date: "10/14/2022"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r Loading libraries include=FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(purrr)
library(tidyr)
library(tidymodels)
library(rpart)
library(rpart.plot)
library(tidyverse)
library(randomForest)
library(caret)
library(DiagrammeR)
library(xgboost)
```

```{r Importing data, include=FALSE}
accountsDataset <- read.csv("datasets/AccountStats4.csv", header = TRUE)
personDataset <- read.csv("datasets/Experiment5.csv", header = TRUE)
accountsUnpivotDataset <- read.csv("datasets/AccountStatsUnpivot.csv", header = TRUE)
retentionDataset <- read.csv("datasets/Retention.csv", header = TRUE)
```

```{r head datasets}
head(accountsDataset)
head(personDataset)
head(accountsUnpivotDataset)
head(retentionDataset)
```

```{r Initial transformations, include=FALSE}
accountsDataset$Mo <- as.Date(accountsDataset$Mo)
accountsDataset$WeekNumber <- as.Date(accountsDataset$WeekNumber)

accountsUnpivotDataset$Mo <- as.Date(accountsUnpivotDataset$Mo)
accountsUnpivotDataset$Type <- as.factor(accountsUnpivotDataset$Type)

retentionDataset$PersonCreatedDate <- as.Date(retentionDataset$PersonCreatedDate)


personDataset[personDataset == "NULL"] <- NA
personDataset$PersonType <- as.factor(personDataset$PersonType)
personDataset$TotalCheckIns <- as.integer(personDataset$TotalCheckIns)
personDataset$Gender <- as.factor(personDataset$Gender)
personDataset$MaritalStatusValueId <- as.factor(personDataset$MaritalStatusValueId)
personDataset$AgeClassification <- as.factor(personDataset$AgeClassification)
personDataset$Age <- as.integer(personDataset$Age)
personDataset$PeopleInFamily <- as.integer(personDataset$PeopleInFamily)
personDataset$ActivationDate <- as.Date(personDataset$ActivationDate)
personDataset$TimeToActivate <- as.integer(personDataset$TimeToActivate)
personDataset$IsImported <- as.factor(personDataset$IsImported)
personDataset$PersonCreatedDate <- as.Date(personDataset$PersonCreatedDate)
personDataset$FirstAttendanceDate <- as.Date(personDataset$FirstAttendanceDate)
personDataset$DaysToFirstAttendance <- as.integer(personDataset$DaysToFirstAttendance)
personDataset$MonthFirstAttendance <- as.factor(personDataset$MonthFirstAttendance)
personDataset$MonthLastAttendance <- as.factor(personDataset$MonthLastAttendance)
personDataset$LastAttendance <- as.Date(personDataset$LastAttendance)
personDataset$MonthsBetweenFirstAndLastAttendance <- as.integer(personDataset$MonthsBetweenFirstAndLastAttendance)
personDataset$NumberOfTransactions <- as.integer(personDataset$NumberOfTransactions)
personDataset$FirstGift <- as.Date(personDataset$FirstGift)
personDataset$LastGift <- as.Date(personDataset$LastGift)
personDataset$MonthsBetweenFirstAndLastGiving <- as.integer(personDataset$MonthsBetweenFirstAndLastGiving)
personDataset$ServingGroups <- as.integer(personDataset$ServingGroups)

```

```{r head datasets after transformations}
summary(personDataset)
```

```{r Accounts Summary - Growth Over Time}
accountsUnpivotDataset %>%
  filter(Type == "TotalAccounts") %>%
  ggplot(aes(x = Mo, y = Number)) +
  geom_line() + 
  ggtitle("Accumulative Rock accounts over time") +
  xlab("Years") + 
  ylab("Number of accounts")
```

```{r Activation rate}
accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersMonth) %>%
  select(Mo, TotalAccounts, ActiveUsers) %>%
  distinct() %>%
  mutate(ActivationRate = round((ActiveUsers / TotalAccounts * 100), digits = 2)) %>%
  ggplot(aes(x = Mo, y = ActivationRate)) +
  geom_line() +
  labs(
    title = "Activation rate over time",
    subtitle = "Number of distinct users who has either an attendance or donation record divided by all users",
    caption = "Good when trending up",
    x = "Years",
    y = "Activation Rate (%)"
    )

accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersMonth) %>%
  select(Mo, TotalAccounts, ActiveUsers) %>%
  distinct() %>%
  mutate(ActivationRate = round((ActiveUsers / TotalAccounts * 100), digits = 2)) %>%
  ggplot(aes(x = Mo, y = ActivationRate)) +
  geom_line( aes(color = "Activation Rate")) +
  geom_line( aes(y = TotalAccounts / 100000, color = "Rock Accounts"))  +
  scale_y_continuous(sec.axis = sec_axis(~.*1, name="Rock Accounts per 100,000")) +
  labs(
    title = "Activation rate over time",
    subtitle = "Number of distinct users who has either an attendance or donation record divided by all users",
    caption = "Good when trending up",
    x = "Years",
    y = "Activation Rate (%)"
    )
  

```

```{r Montlhy Active Users (MAU)}
accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersMonth) %>%
  select(Mo,ActiveUsers) %>%
  ggplot(aes(x = Mo, y = ActiveUsers)) +
  geom_line() +
  labs(
      title = "Montlhy Active Users (MAU)",
      subtitle = "Number of distinct users who has either an attendance or donation record by month",
      caption = "Good when trending up",
      x = "Years",
      y = "Active Users"
      ) 
```

```{r Weekly Active Users (WAU)}
accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersWeek) %>%
  select(WeekNumber,ActiveUsers) %>%
  group_by(WeekNumber) %>%
  summarise(TotalActiveUsers = sum(ActiveUsers)) %>%
  ggplot(aes(x = WeekNumber, y = TotalActiveUsers)) +
  geom_line() +
  labs(
      title = "Weekly Active Users (WAU)",
      subtitle = "Number of distinct users who has either an attendance or donation record by week",
      caption = "Good when trending up",
      x = "Years",
      y = "Active Users"
      ) +
  geom_smooth(method = "loess", level = .95) 
```


```{r Stickiness (AVG(WAU)/MAU), message=FALSE, warning=FALSE}
accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  select(Mo,ActiveUsersMonth,ActiveUsersWeek) %>%
  group_by(Mo) %>%
  summarise(Stickiness = mean(ActiveUsersWeek) / ActiveUsersMonth) %>%
  distinct() %>%
  ggplot(aes(x = Mo, y = Stickiness * 100)) +
  geom_line() +
  labs(
      title = "Stickiness",
      subtitle = "Stickiness shows how often users or atendees are coming back each month.",
      caption = "Good when close to 100%",
      x = "Years",
      y = "Stickiness (%)"
      ) 

accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  select(Mo,ActiveUsersMonth,ActiveUsersWeek) %>%
  group_by(Mo) %>%
  summarise(Stickiness = mean(ActiveUsersWeek) / ActiveUsersMonth) %>%
  distinct() %>%
  ggplot(aes(x = Mo, y = Stickiness * 100)) +
  geom_line() +
  labs(
      title = "Stickiness",
      subtitle = "Stickiness shows how often users or atendees are coming back each month.",
      caption = "Good when close to 100%",
      x = "Years",
      y = "Stickiness (%)"
      ) + 
  geom_smooth(method = "loess")
  
```


```{r Investigating factors -- decision tree , message=FALSE, warning=FALSE}

#boxplot(personDataset$Age, outline = FALSE)
outliersAge <- boxplot(personDataset$Age, plot=FALSE)$out


#boxplot(personDataset$PeopleInFamily, outline = FALSE)
outliersPeoplInFamily <- boxplot(personDataset$PeopleInFamily, plot=FALSE)$out


#boxplot(personDataset$TimeToActivate, outline = FALSE)
outliersTimeToActivate <- boxplot(personDataset$TimeToActivate, plot=FALSE)$out


#boxplot(personDataset$DaysToFirstAttendance, outline = TRUE)
outliersDaysToFirstAttendance <- boxplot(personDataset$DaysToFirstAttendance, plot=FALSE)$out
## NOT SURE ABOUT THIS ONE


#boxplot(personDataset$MonthsBetweenFirstAndLastAttendance, outline = FALSE)
outliersMonthsBetweenFirstAndLastAttendance <- boxplot(personDataset$MonthsBetweenFirstAndLastAttendance, plot=FALSE)$out

#boxplot(personDataset$NumberOfTransactions, outline = TRUE)
outliersMonthsBetweenFirstAndLastAttendance <- boxplot(personDataset$MonthsBetweenFirstAndLastAttendance, plot=FALSE)$out
## NOT SURE ABOUT THIS ONE EITHER

#boxplot(personDataset$MonthsBetweenFirstAndLastGiving, outline = TRUE)
outliersMonthsBetweenFirstAndLastAttendance <- boxplot(personDataset$MonthsBetweenFirstAndLastAttendance, plot=FALSE)$out
## NOT SURE ABOUT THIS ONE EITHER

#boxplot(personDataset$ServingGroups, outline = FALSE)
outliersMonthsBetweenFirstAndLastAttendance <- boxplot(personDataset$MonthsBetweenFirstAndLastAttendance, plot=FALSE)$out
## NOT SURE ABOUT THIS ONE EITHER

#boxplot(personDataset$TotalCheckIns, outline = FALSE)
outliersTotalCheckIns <- boxplot(personDataset$TotalCheckIns, outline = FALSE)$out

# Evaluating numeric variables
personDataset %>%
  select(-Id, -Baptism, -CommitToChrist, -IAnNew, -PrayerRequest, -RenewCommitToChrist, -X3MonthTitheChallenge, -DaysToFirstAttendance) %>%
  mutate(Age = ifelse(is.na(Age), 0, Age)) %>%
  #filter(IsImported == 0) %>%
  keep(is.numeric) %>% 
  filter(TimeToActivate > 0) %>%
  filter(!Age %in% outliersAge) %>%
  filter(!PeopleInFamily %in% outliersPeoplInFamily) %>%
  filter(!TimeToActivate %in% outliersTimeToActivate) %>%
  filter(!MonthsBetweenFirstAndLastAttendance %in% outliersMonthsBetweenFirstAndLastAttendance) %>%
  filter(!TotalCheckIns %in% outliersTotalCheckIns) %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()



cleanPersonDataset <- personDataset %>%
  select(-Id, -Baptism, -CommitToChrist, -IAnNew, -PrayerRequest, -RenewCommitToChrist, -X3MonthTitheChallenge, -ActivationDate, -PersonCreatedDate, -FirstAttendance, -LastAttendance, -FirstGift, -LastGift, -MonthFirstAttendance, -MonthLastAttendance, -FirstAttendanceDate) %>%
  mutate(Age = ifelse(is.na(Age), 0, Age)) %>%
  ##filter(IsImported == 0) %>%
  filter(TimeToActivate > 0) %>%
  filter(!Age %in% outliersAge) %>%
  filter(!PeopleInFamily %in% outliersPeoplInFamily) %>%
  filter(!TimeToActivate %in% outliersTimeToActivate) %>%
  filter(!TotalCheckIns %in% outliersTotalCheckIns) %>%
  filter(!MonthsBetweenFirstAndLastAttendance %in% outliersMonthsBetweenFirstAndLastAttendance) %>%
  filter(!DaysToFirstAttendance %in% outliersDaysToFirstAttendance) %>%
  mutate(TwoMonthsWithoutActivity = as.factor(TwoMonthsWithoutActivity)) %>%
  mutate(TwoMonthsWithoutActivity = str_replace(TwoMonthsWithoutActivity, "1", "LeaveTheChurch")) %>%
  mutate(TwoMonthsWithoutActivity = str_replace(TwoMonthsWithoutActivity, "0", "StayAtChurch")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "143", "Married")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "144", "Single")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "675", "Unknown")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "1792", "Unknown")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "1886", "Unknown")) %>%
   mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "676", "Unknown")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "3471", "Unknown")) %>%
  mutate(MaritalStatusValueId = str_replace(MaritalStatusValueId, "2198", "Unknown")) %>%
  mutate(MaritalStatusValueId = as.factor(MaritalStatusValueId)) %>%
  mutate(ServingGroups = ifelse(is.na(ServingGroups), 0, ServingGroups)) %>%
  mutate(Volunteer = as.factor(ifelse(ServingGroups > 0, 1, 0))) %>%
  select(-ServingGroups) %>%
  mutate(Gender = str_replace(Gender, "0", "Unknown")) %>%
  mutate(Gender = str_replace(Gender, "1", "Male")) %>%
  mutate(Gender = str_replace(Gender, "2", "Female"))
  
  
```

```{r testing DT 10x}

set.seed(987)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt1 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt1 <- predict(dt1, PersonDataset_test, type = 'class')
cm_dt1 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt1))
acc_dt1 <- cm_dt1$overall['Accuracy']
rpart.plot(dt1)

set.seed(887)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt2 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt2 <- predict(dt2, PersonDataset_test, type = 'class')
cm_dt2 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt2))
acc_dt2 <- cm_dt2$overall['Accuracy']
rpart.plot(dt2)

set.seed(787)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt3 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt3 <- predict(dt3, PersonDataset_test, type = 'class')
cm_dt3 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt3))
acc_dt3 <- cm_dt3$overall['Accuracy']
rpart.plot(dt3)

set.seed(687)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt4 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt4 <- predict(dt4, PersonDataset_test, type = 'class')
cm_dt4 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt4))
acc_dt4 <- cm_dt4$overall['Accuracy']
rpart.plot(dt4)

set.seed(587)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt5 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt5 <- predict(dt5, PersonDataset_test, type = 'class')
cm_dt5 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt5))
acc_dt5 <- cm_dt5$overall['Accuracy']
rpart.plot(dt5)

set.seed(487)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt6 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt6 <- predict(dt6, PersonDataset_test, type = 'class')
cm_dt6 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt6))
acc_dt6 <- cm_dt6$overall['Accuracy']
rpart.plot(dt6)

set.seed(387)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt7 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt7 <- predict(dt7, PersonDataset_test, type = 'class')
cm_dt7 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt7))
acc_dt7 <- cm_dt7$overall['Accuracy']
rpart.plot(dt7)

set.seed(287)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt8 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt8 <- predict(dt8, PersonDataset_test, type = 'class')
cm_dt8 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt8))
acc_dt8 <- cm_dt8$overall['Accuracy']
rpart.plot(dt8)

set.seed(187)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt9 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt9 <- predict(dt9, PersonDataset_test, type = 'class')
cm_dt9 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt9))
acc_dt9 <- cm_dt9$overall['Accuracy']
rpart.plot(dt9)

set.seed(87)
PersonDataset_split <- initial_split(cleanPersonDataset, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training <- PersonDataset_split %>% training()
PersonDataset_test <- PersonDataset_split %>% testing()

dt10 = rpart(TwoMonthsWithoutActivity ~ ., data = PersonDataset_training, method="class", minsplit = 10, minbucket=3) 
predict_dt10 <- predict(dt10, PersonDataset_test, type = 'class')
cm_dt10 <- confusionMatrix(table(PersonDataset_test$TwoMonthsWithoutActivity, predict_dt10))
acc_dt10 <- cm_dt10$overall['Accuracy']
rpart.plot(dt10)

#TODO
# Find another way to test the dimensioonaity redsuction
# test random -- try 10 different settings change -- 
# gboost
# trend line of people imported and not imported

# Quantas pessoas eu errei?
#

# Try 65% testing
```


```{r running a different model}
cleanPersonDataset_model2 <- cleanPersonDataset %>%
  mutate(TwoMonthsWithoutActivity = as.character(cleanPersonDataset$TwoMonthsWithoutActivity)) %>%
  mutate(MaritalStatusValueId = as.character(cleanPersonDataset$MaritalStatusValueId)) %>%
  filter(PersonType == 1) %>%
  select(-PersonType, -MaritalStatusValueId) %>%
  filter(AgeClassification == 2 | AgeClassification == 1) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  mutate(AgeClassification = as.numeric(AgeClassification)) %>%
  mutate(IsImported = as.numeric(IsImported)) %>%
  mutate(TwoMonthsWithoutActivity = as.numeric(ifelse(TwoMonthsWithoutActivity == "StayAtChurch", 1,0)))


set.seed(987)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
xgb.plot.tree(model = bst)

set.seed(887)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(787)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(687)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(587)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(487)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(387)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(287)
PersonDatset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(187)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)

set.seed(87)
PersonDataset_split_model2 <- initial_split(cleanPersonDataset_model2, prop = 0.80, strata = TwoMonthsWithoutActivity)
PersonDataset_training_model2 <- PersonDataset_split_model2 %>% training()
PersonDataset_test_model2 <- PersonDataset_split_model2 %>% testing()

dtrain <- xgb.DMatrix(data = as.matrix(PersonDataset_training_model2[1:length(PersonDataset_training_model2)-1]) ,label=PersonDataset_training_model2$TwoMonthsWithoutActivity)
dtest <- xgb.DMatrix(data = as.matrix(PersonDataset_test_model2[1:length(PersonDataset_test_model2)-1]), label=PersonDataset_test_model2$TwoMonthsWithoutActivity)

watchlist <- list(train=dtrain, test=dtest)

bst <- xgb.train(data=dtrain, max.depth=3, eta=0.3, nthread = 2, nrounds=2, watchlist=watchlist, objective = "binary:logistic", booster = "gbtree", verbose = 0)

importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
#xgb.plot.tree(model = bst)






```



```{r r Investigating factors -- random forest , message=FALSE, warning=FALSE}
set.seed(987)

rf <-randomForest(as.factor(TwoMonthsWihtoutActivity)~.,data=cleanPersonDataset, ntree=500) 
print(rf)
varImpPlot(rf)

# trControl <- trainControl(method = "cv",
#     number = 10,
#     search = "grid")
# 
# rf_default <- train(as.factor(TwoMonthsWihtoutActivity)~.,
#     data = PersonDataset_training,
#     method = "rf",
#     metric = "Accuracy",
#     trControl = trControl)
# 
# print(rf_default)
# 
# set.seed(987)
# tuneGrid <- expand.grid(.mtry = c(1: 15))
# rf_mtry <- train(as.factor(TwoMonthsWihtoutActivity)~.,
#     data = PersonDataset_training,
#     method = "rf",
#     metric = "Accuracy",
#     tuneGrid = tuneGrid,
#     trControl = trControl,
#     importance = TRUE,
#     nodesize = 14,
#     ntree = 500)
# print(rf_mtry)
# best_mtry <- rf_mtry$bestTune$mtry # >> 8
# 
# ## Search the best maxnodes
# store_maxnode <- list()
# tuneGrid <- expand.grid(.mtry = best_mtry)
# for (maxnodes in c(5: 15)) {
#     set.seed(1234)
#     rf_maxnode <- train(as.factor(TwoMonthsWihtoutActivity)~.,
#         data = PersonDataset_training,
#         method = "rf",
#         metric = "Accuracy",
#         tuneGrid = tuneGrid,
#         trControl = trControl,
#         importance = TRUE,
#         nodesize = 14,
#         maxnodes = maxnodes,
#         ntree = 500)
#     current_iteration <- toString(maxnodes)
#     store_maxnode[[current_iteration]] <- rf_maxnode
# }
# results_mtry <- resamples(store_maxnode)
# summary(results_mtry) ## maxnodes >> 14
# 
# ## Search the best ntrees
# 
# store_maxtrees <- list()
# for (ntree in c(250, 300, 350, 400, 450, 500, 550, 600, 800, 1000, 2000)) {
#     set.seed(5678)
#     rf_maxtrees <- train(as.factor(TwoMonthsWihtoutActivity)~.,
#         data = PersonDataset_training,
#         method = "rf",
#         metric = "Accuracy",
#         tuneGrid = tuneGrid,
#         trControl = trControl,
#         importance = TRUE,
#         nodesize = 14,
#         maxnodes = 24,
#         ntree = ntree)
#     key <- toString(ntree)
#     store_maxtrees[[key]] <- rf_maxtrees
# }
# results_tree <- resamples(store_maxtrees)
# summary(results_tree) ## >> 500
# 
# 
# ntree = 500
# mtry = 8
# maxnodes = 14


fit_rf <- train(as.factor(TwoMonthsWihtoutActivity)~.,
    PersonDataset_training,
    method = "rf",
    metric = "Accuracy",
    tuneGrid = expand.grid(.mtry = 8),
    trControl = trainControl(method = "cv",number = 10, search = "grid"),
    importance = TRUE,
    nodesize = 14,
    ntree = 500,
    maxnodes = 14)

prediction <-predict(fit_rf, PersonDataset_test)

confusionMatrix(prediction, as.factor(PersonDataset_test$TwoMonthsWihtoutActivity))


```

```{r}
accountsDataset %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersWeek) %>%
  select(WeekNumber,ActiveUsers) %>%
  group_by(WeekNumber) %>%
  summarise(TotalActiveUsers = sum(ActiveUsers)) %>%
  ggplot(aes(x = WeekNumber, y = TotalActiveUsers)) +
  geom_line() +
  labs(
      title = "Weekly Active Users (WAU)",
      subtitle = "Number of distinct users who has either an attendance or donation record by week",
      caption = "Good when trending up",
      x = "Years",
      y = "Active Users"
      )



accountsDatasetNew <- read.csv("datasets/AccountStats5.csv", header = TRUE)

accountsDatasetNew$Mo <- as.Date(accountsDatasetNew$Mo)
accountsDatasetNew$WeekNumber <- as.Date(accountsDatasetNew$WeekNumber)


accountsDatasetNew %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  rename(ActiveUsers = ActiveUsersWeek) %>%
  select(WeekNumber,ActiveUsers) %>%
  group_by(WeekNumber) %>%
  summarise(TotalActiveUsers = sum(ActiveUsers)) %>%
  ggplot(aes(x = WeekNumber, y = TotalActiveUsers)) +
  geom_line() +
  labs(
      title = "Weekly Active Users (WAU)",
      subtitle = "Number of distinct users who has either an attendance or donation record by week",
      caption = "Good when trending up",
      x = "Years",
      y = "Active Users"
      )

accountsDatasetNew %>%
  filter(format(Mo,'%Y') >= "2018") %>%
  group_by(Mo, Weeks) %>%
  summarise(AWA = mean(ActiveUsersWeek)) %>%
  select(Mo, AWA) %>%
  ggplot(aes(x = Mo, y = AWA)) +
  geom_line() +
  labs(
      title = "Montlhy AverageWeeklyActivation",
      subtitle = "Mean of users who has either an attendance or donation record by week",
      caption = "Good when trending up",
      x = "Years",
      y = "AWA"
      )

```


TODO: 
  * There is room to clean up the data by removing weird number such negative age
  * The distribution is too weird
  
```{r}
library(stats)
install.packages("factoextra")
library(factoextra)
library(mice)



personDatasetSimplified <- personDataset %>%
  select(-Id, -PersonCreatedDate, -FirstAttendanceDate, -LastAttendanceDate, -ActivationDate, -FirstGift, -LastGift)

personDatasetSimplified$Age <- replace_na(personDatasetSimplified$Age, 0)
personDatasetSimplified$TimeToActivate <- replace_na(personDatasetSimplified$TimeToActivate, 1000)

md.pattern(personDatasetSimplified)
summary(personDatasetSimplified)

set.seed(123)
km.res <- kmeans(personDatasetSimplified, 4, nstart = 25)
print(km.res)
```


```{r}
personDatasetSimplifiedNumeric <- personDatasetSimplified %>%
  keep(is.numeric)

results <- prcomp(personDatasetSimplifiedNumeric, scale = TRUE)

results$rotation <- -1*results$rotation

results$rotation

results$x <- -1*results$x

head(results$x)

biplot(results, scale = 0)
```




Now that we have a better understanding of how often attendees are coming back or active let's see how long it takes for an attendee to become active after creating their account. 

```{r Time to Activate, message=FALSE, warning=FALSE}
personDataset %>%
  filter(format(PersonCreatedDate,'%Y') >= "2018" & TimeToActivate >= 0 ) %>%
  select(Id, PersonCreatedDate, TimeToActivate, ActivationDate) %>%
  mutate(Mo = floor_date(ymd(PersonCreatedDate), 'month' ) ) %>%
  group_by(Mo) %>%
  summarise(activation = mean(TimeToActivate)) %>%
  ggplot(aes(x = Mo, y = activation)) +
  geom_line() +
  labs(
      title = "Days to activate",
      subtitle = "Mean days to activate (donate or attend).",
      caption = "Good when trending down",
      x = "Years",
      y = "Mean days to activation"
      )
```

```{r Time to Activate Histogram, message=FALSE, warning=FALSE}
personDataset %>%
  filter(format(PersonCreatedDate,'%Y') >= "2018" & TimeToActivate >= 0 & TimeToActivate <= 100) %>%
  select(Id, PersonCreatedDate, TimeToActivate, ActivationDate) %>%
  ggplot(aes(x=TimeToActivate)) +
  geom_histogram(binwidth=20) +
  labs(
      title = "Days to activate histogram",
      x = "Days to activate",
      y = "Frequency"
      )
```
As we can observe, the church is doing an excellent job by quickly activating its members. The histogram shows that most of the time, the activation happens within 20 days after creating the Rock account. The activation might become a good indicator of whether the new Rock account is just a new lead or is, indeed, a potential member. 

### Summary

At this point, we learned a lot about the speed and growth of the church. 

We saw that measuring growth just by the number of new accounts is not enough because, frequently, a new account may never engage with the church. 

The monthly/weekly activation users (MAU/WAU - the measure of members who either donated or attended a service) seem to provide a better perspective because it pays close attention to engaged members. 

These metrics allow calculating the Stickiness, which tells us that, in this case, members are engaging 2 out of 4 weeks every month. Stickiness is an excellent metric for church leaders to place efforts into improving it.

Finally, we calculated how fast members started engaging with the church after creating an account. Our case study results are surprisingly good, with the mean decreasing from 400 to very close to 0 days over the years. 

Now it is time to find metrics to help us understand if this church is keeping its member engaged over time. 

## Can we identify patterns that cause people to stay?


```{r Unbounded Retention}
retentionDataset %>%
  mutate(Mo = floor_date(ymd(PersonCreatedDate), 'month' ) ) %>%
  filter(RetentionDays < 60) %>%
  ggplot(aes(x=RetentionDays)) +
  geom_histogram(binwidth=7, aes(y = ..density..)) +
  geom_density(lwd = 1, colour = 4,fill = 4, alpha = 0.25) +
  labs(
      title = "Retention",
      subtitle = "measures how often your users are coming back to engage with your product.",
      caption = "Good when high density is close to zero",
      x = "Days to come back -- each bin represents a week",
      y = "Density"
      )
write.csv(personDataset, "data.csv")
```
The unbounded retention metric helps grocery shops or travel apps that do not expect a customer to come back every day to measure when their customer returns. It helps measure customer engagement. 

Since this is a church, I decided to plot the result in a histogram where each bin represents each week (7 days) so we can see how many weeks it takes for a member to return after creating their accounts. 

The retention is often calculated in a rate fashion, so I am plotting the density so we can see that roughly 30% of new members will come back within three weeks
